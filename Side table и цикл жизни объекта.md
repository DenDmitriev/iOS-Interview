# Side table

Side Table — механизм, с помощью которого реализуются слабые ссылки. Предствляет собой область в памяти, содержащая некоторую дополнительную информацию об объекте, которую не нужно хранить в нем самом. В ней хранятся счетчики ссылок. Не каждый объект содержит слабые ссылки, следовательно, и боковые таблицы, иначе это было бы расточительно. Вместо того чтобы напрямую указывать на объект, слабая ссылка указывает на боковую таблицу, которая, в свою очередь указывает на объект.

Первоначально объект содержит pointer и имеет только два счетчика ссылок. Боковой таблицы нет, ибо объект в ней никак не нуждается. При увеличении счетчика сильных ссылок всё работает как обычно, и ничего особенного не происходит.

![81d01b6920f5d497ad2f35f29775540f](https://github.com/DenDmitriev/iOS-Interview/assets/65191747/527db48e-b033-46ca-be32-db90c11acb70)

Во втором поле резервируется один бит, по которому определяется, используется ли сейчас боковая таблица в этом поле или здесь хранится счетчик ссылок.

Как только мы начинаем ссылаться на объект слабо (weak reference), то создается боковая таблица, и теперь объект вместо сильного счетчика ссылок хранит ссылку на боковую таблицу. Сама боковая таблица также имеет ссылку на объект. 

![b482e8f80cd29ff43950e33b832d58e6](https://github.com/DenDmitriev/iOS-Interview/assets/65191747/731931f4-1b2f-438e-9cab-db810767ff34)


Такое поведение решает две проблемы:
 - Экономия памяти, поскольку память объекта освобождается.
 - Наличие безопасного обнуления слабой ссылки, поскольку слабая ссылка теперь не указывает напрямую на объект и не является предметом race condition.

Боковая таблица — счетчик ссылок + указатель на объект и отображается в Swift Runtime следующим образом:

```swift
class HeapObjectSideTableEntry {
  std::atomic<HeapObject*> object;
  SideTableRefCounts refCounts;
  // Операции по увеличению и уменьшению счетчиков ссылок
}
```
## Источники:
 - [iOS Interview](https://ios-interview.ru/side-table/)
 - [Память в Swift от 0 до 1](https://habr.com/ru/companies/hh/articles/546856/)
