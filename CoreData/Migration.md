# Migration
Обычно после создания модели данных наступает момент обновления и случается что нужно изменить модель, например добавить новое свойство. Но что делать, ведь вы не хотите ломать приложение для уже существующих пользователей? Вы не можете предсказать будущее, но с Core Data вы можете перенестись в него вместе с каждым релизом вашего приложения. Это назывется миграцией. 

Миграция - это процесс в котором происходит обновление данных, созданных в предыдущей версии модели данных, чтобы соответствовать текущей модели данных.

## Когда нам нужна миграция?
Когда нам нужно внести изменения в нашу модель данных. Кроме случаев если ваше приложение использует Core Data лишь как офлайн кэш, то когда вы обновляете ваше приложение - вы просто удаляете и отстраиваете заново хранение данных. И вам стоит делать это, если первоначальным источником данных пользователя является не хранилище данных.

## Процесс миграции
Когда вы инициализируете стек Core Data, то одним из этапов по инициализации является добавление координатора хранилища `NSPersistentStoreCoordinator`. Когда вы попадаете на этот этап, Core Data выполняет еще кое-какие действия перед добавлением этого хранилища координатору. Сначала Core Data анализирует модель хранилища, затем сравнивает ее с моделью хранилища координатора. Если они не совпадают, то Core Data осуществляет миграцию, в случае ее разрешения.

> Если миграции не разрешены и хранилище не совместимо с моделью данных, то Core Data просто не соединяет хранилище с координатором, что вызывает соответствующую ошибку.

Для того, чтобы начать миграцию Core Data требуется исходная модель данных и конечная. Она использует эти две версии, чтобы создать модель отображения для миграции, которую она использует для конвертирования данных из исходного хранилища, в данные нового хранилища. Как только Core Data определила модель миграции, то сам процесс миграции может быть начат.

### Этапы миграций
Миграция происходит в три этапа:
1. Сначала Core Data копирует все объекты одного хранилища в следующее.
2. Далее, Core Data соединяет и соотносит все объекты, исходя из взаимоотношений.
3. Проверяет соответствие данных в конечной модели, отключает проверку данных в конечной модели на этапе копирования.

Вы можете спросить: "Но если что-то пойдет не так, что случится с хранилищем исходных данных?". С ним ничего не происходит до тех пор, пока Core Data не подтвердит успешность завершения миграции, после чего исходное хранилище удаляется.

## Типы миграций
- lightweight (простая). Вы просто ставите пару галочек при настройке Core Data и миграция происходит автоматически.
- heavyweight (сложная). 
  - manual. Вам нужно определить соответствие набора старых данных, в соответствии с новым набором.
  - custom manual. Cоздание подкласса NSEntityMigrationPolicy, где и производится пользовательская трансформация.
  - total manual. Миграции, которые полностью проводятся вручную

# Простая миграция (lightweight)
Наша модель данных созданная в предыдущих статьях не имеет достаточной информации о планетах в солнечной системе. А имеено не имеет верной сортировки планет относительно звезды.

<img width="559" alt="Снимок экрана 2024-03-14 в 08 01 33" src="https://github.com/DenDmitriev/iOS-Interview/assets/65191747/226616ea-0c35-468b-ae7e-911f6b9c932b">

Текущая модель данных не имеет возможности предоставления информации такого рода, значит вы должны добавить дополнительное место в модели данных для хранения очередности планет. Но вы уже добавили планеты солнечной системы и звезду, как теперь вы сможете поменять их модель данных не удаляя их? Вот и настало время вашей первой миграции!
Давайте добавим поле указывающее очередность расположения планет относительно звезды. Для этого создадим новую версию базы данных. Нажмите Editor -> Add Model Version

<img width="379" alt="Снимок экрана 2024-03-14 в 08 00 59" src="https://github.com/DenDmitriev/iOS-Interview/assets/65191747/332974b4-d1c0-47e4-b99e-a87f227c1476">

> Вы можете дать этому файлу любое имя, какое только захотите. Последовательное обозначение v2, v3, v4 помогает отследить последовательное изменение версий.

<img width="749" alt="Снимок экрана 2024-03-14 в 08 07 08" src="https://github.com/DenDmitriev/iOS-Interview/assets/65191747/a0697ae0-b273-47c4-9eff-489330798ec9">

Этот шаг создаст вторую версию вашей модели данных, но вам все еще нужно сообщить Xcode, чтобы он использовал новую версию в качестве рабочей модели. В инспекторе файла (File Inspector), справа вверху, найдите секцию Model Version. Выберите в поле "current" CoreDataDocumentation v2:




## Источники:
- [Core Data: Часть 2. Lightweight Миграции](https://swiftbook.ru/post/tutorials/core-data-chast-2-lightweight-migracii/)
