# Сopy-on-Write (COW)

Механизм в Swift, который копирует поведение ссылочных типов на типы значений до первых изменений. 

## Что нам это дает?
Это избавляет нашу программу от лишних копирований, тем самым улучшая производительность.

## Как работает?
Как известно основным отличием ссылочных типов от типов значений является то, что первые передаются по ссылкам, в то время как вторые копируются. У этого есть ряд своих плюсов таких как то, что типы значений работают быстрее, потому что хранятся на стеке, а не в куче, используют статическую диспетчеризацию и прочее. 
Однако можно задаться вопросом “а зачем копировать данные, если мы их не меняем?”. Действительно и COW как раз-таки отвечает на этот вопрос и говорит, что это не обязательно.

Проведем небольшой эксперимент:
```swift
func address(_ o: UnsafeRawPointer, _ name: String) {
  print(name, "address: \(Int(bitPattern: o))")
}

var arr1 = [1, 2, 3]
var arr2 = arr1

address(arr1, "arr1") // arr1 address: 105553156825120
address(arr2, "arr2") // arr2 address: 105553156825120
// Обе переменные ссылаются на одну область памяти, хотя мы и работаем с типом значений и данные первой переменной должны были бы копироваться во вторую.

// А теперь изменим второй массив и посмотрим что будет.
arr2.append(4)

address(arr1, "arr1")  // arr1 address: 105553156825120
address(arr2, "arr2") // arr2 address: 105553133600496
// Как можно заметить теперь ссылки ведут на разные области в памяти.
```

## Источники
 - [Copy-on-write](https://habr.com/ru/articles/673372/)
