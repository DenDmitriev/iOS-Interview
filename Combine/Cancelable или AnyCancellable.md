# AnyCancellable
Когда мы работаем с Combine нам нужно сохранять свои подписки. Отмена подписок являются важной частью работы с Combine.

AnyCancellable - это класс стираемого типа, который соответствует Cancelable, который позволяет абонентам отменить подписку, не имея возможности получить доступ к базовой подписке, чтобы сделать такие вещи, как запрос большего количества элементов.

## Пример
Например, вы могли создать издателя, который обертывает `CLLocationManagerDelegate` и раскрывает текущее местоположение пользователя с издателем `currentLocatio`n, который является `CurrentValueSubject<CLLocation, Never>`. Подписка на этого издателя будет выглядеть немного так:
```swift
struct ViewModel {
    let locationProvider: LocationProvider
    var cancellables = Set<AnyCancellable>()

  init(locationProvider: LocationProvider) {
        self.locationProvider = locationProvider
        locationProvider.currentLocation.sink { newLocation in 
            // use newLocation
        }.store(in: &cancellables)
    }
}
```

Для чего-то, что так важно для работы с Combine, кажется, что `cancellable` - это просто то, с чем мы имеем дело, не ставя это под сомнение. Вот почему в этом посте я хотел бы поближе взглянуть на то, что такое `cancellable`, и, более конкретно, я хотел бы посмотреть на то, что именно является загадочным `AnyCancellable`, который возвращается как `sink`, так и `assign(to:on:)`

## Понимание цели cancellables в Combine
cancellables в Combine выполняет важную роль в жизненном цикле подписки Combine. По данным Apple, Cancelable протокол заключается в следующем:

### Cancelable
> Протокол, указывающий на то, что действие или активность поддерживает отмену.
```swift
public protocol Cancellable {
    /// Отменить активность.
    ///
    /// При реализации `Cancellable` для поддержки пользовательского издателя реализуйте `cancel()`, чтобы запросить,
    /// чтобы ваш издатель прекратил звонить своим нижестоящим подписчикам.
    /// Комбайн не требует немедленной остановки издателя, но вызов `cancel()` должен вступить в силу быстро.
    /// Отмена также должна устранить любые сильные ссылки, которые он имеет в настоящее время.
    ///
    /// После того, как вы отправите один вызов `cancel()`, последующие вызовы не должны ничего делать.
    /// Кроме того, ваша реализация должна быть потокобезопасной и не должна блокировать вызывающую программу.
    ///
    /// > Совет: имейте в виду, что функция `cancel()` может выполняться одновременно с другим вызовом `cancel()` --- включая сценарий,
    /// в котором `AnyCancellable` освобождает --- или `Subscription/request(_:)`.
     func cancel()
}
```

Если мы посмотрим на подробное описание Cancellable, вы обнаружите, что в нем говорится следующее:

> Вызов `cancel()` освобождает все выделенные ресурсы. Это также останавливает побочные эффекты, такие как таймеры, доступ к сети или запись/чтение на диске.

Мы знаем, что можем ожидать, что любые выделенные ресурсы будут освобождены. Это действительно полезно знать.

Давайте посмотрим на документацию для AnyCancellable. Может быть, Cancelable и AnyCancellable не совсем одинаковы, хотя мы ожидали, что AnyCancellable будет не более чем стираемым типом Cancellable, основываясь на том, как Apple решила назвать его.

В кратком описании объясняется следующее:
```swift
/// An ``AnyCancellable`` instance automatically calls ``Cancellable/cancel()`` when deinitialized.
final public class AnyCancellable : Cancellable, Hashable {
 // ...
}
```
> Объект, стирающий тип, который автоматически вызывает `Cancellable/cancel()` при деинициализации.

Это "просто" объект, стертого типа, который соответствует Cancellable, мы можем предусмотреть замыкание если хотим что-либо сделать, когда мы инициализируем `AnyCancellable`. Когда мы подписываемся на издателя, мы не создаем свой собственный AnyCancellable, поэтому нам нужно будет копнуть немного глубже.

В документации `AnyCancellable` есть одно предложение, которое точно говорит нам, почему нам нужно сохранить cancellables. Это самое последнее предложение в обсуждении, и оно гласит следующее:
> Экземпляр `AnyCancellable` автоматически вызывает `cancel()` при деинициалировании.

Когда мы сохраняем `AnyCancellable` в экземпляре модели представления, контроллера просмотра или любого другого объекта, жизненный цикл этой подписки связывается с жизненным циклом владельца (объекта сохранения). Всякий раз, когда владелец анулирует объекты `AnyCancellable`, подписка сбрасывается, и все ресурсы немедленно освобождаются.

Вы не просто отмените подписку как если вы получили бы уведомление об этом при закрытии receiveCompletion. Вместо этого вся подписка немедленно срывается. Вы не будете проинформированы об этом, и вы не сможете отреагировать на это при закрытии receiveCompletion.

# Цель `AnyCancellable`
Используются для привязки жизненного цикла подписки к объекту, который сохраняет cancellable, который мы получаем при подписке на издателя.

## Является ли AnyCancellable подпиской?
Нет. Это `AnyCancellable`. На практике мы знаем, что `AnyCancellable`, скорее всего, обернет объект, который соответствует `Subscription`, а также, возможно, соответствующий `Subscriber`.

## Итоги
Что находится внутри AnyCancellable не имеет значения. Вам просто нужно помнить, что когда AnyCancellable будет деинициализирован, он запустит свое завершение `cancel()`, что уничтожит все, что он хранил. Это включает в себя отмену вашей подписки на издателя.

## Источники:
- [What exactly is a Combine AnyCancellable?](https://www.donnywals.com/what-exactly-is-a-combine-anycancellable/)
