# Жизненный цикл приложения
Жизненный цикл приложения представляет собой последовательность событий, которые происходят между запуском и завершением приложения.
Когда пользователь нажимает на значок вашего приложения, SpringBoard запускает ваше приложение

> SpringBoard - это стандартное приложение, которое управляет домашним экраном iPhone. Другие задачи включают запуск WindowServer, запуск и загрузку приложений и настройку некоторых настроек устройства при запуске.

Пока SpringBoard анимизирует экран запуска вашего приложения, ваше приложение и необходимые общие библиотеки будут загружены в память. В конце концов, ваше приложение начинает выполнение, и делегат приложения получает уведомления.
> AppDelegate - это объект делегирования приложения. Он наследует класс `UIResponder` и реализует протокол делегата `UIApplicationDelegate`

UIApplicationDelegate - это протокол, который нужен чтобы получать уведомления о событиях пользователей, таких как запуск приложения, приложение переходит в фоновый или передний план, приложение прекращается, было открыто push-уведомление и т. д.
Класс UIResponder позволяет AppDelegate реагировать на пользовательские события, а UIApplicationDelegate позволяет AppDelegate быть объектом делегирования приложения для управления и реагирования на жизненный цикл приложения.

## Основной цикл работы
В любой момент времени ваше приложение находится в одном из пяти состояний:

| Состояния | Описание |
| ----------- | ----------- |
| Not-Running Не запущено | Приложение не было запущено, или запущено, но было преостановлено   |
| Inactive Неактивно | Приложение работает, но в настоящее время в нем нет активных событий. Обычно в таком состоянии находится недолго, т.к. вскоре переходит в другое состояние. |
| Active Активно | Приложение запущено и в настоящее время в нем происходят какие-то события. Это нормальный режим любого приложение, когда оно работает. |
| Background Фоновый режим | Приложение находится в фоновом режиме и выполняет определенный код. Большинство приложений в этом состоянии также находятся недолго. Однако, приложение может запросить дополнительное время, для работы в этом режиме. И это состояние заменяет состояние Inactive(неактивно) |
| Suspended Приостановлено | Приложение находится в фоновом режиме, но не выполняет код. Система автоматически помещает приложения в это состояние, без предупреждения. При остановке, приложение находится в памяти, но оно ничего не выполняет. Когда памяти будет не хватать, то система может очистить это приложение из нее, чтобы дать память приложениям с активным состоянием  |

Сейчас рассмотрим как же приложение меняет эти состояния. На картинке ниже представлена схема состояний.

![UIAplicationState](https://github.com/DenDmitriev/iOS-Interview/assets/65191747/e7ccfb2a-97fb-4bbe-adf7-6bb66a2b4b3e)

## Переходы состояний
Приложение может переходить следующими способами.

`Not-running -> Inactive -> Active -> Inactive -> Background -> Inactive -> Active`

Основные перемещения между состояния вызывают определенные методы указанные в объекте приложения. Эти методы дают вам возможность обработать изменение состояний.
 - `application:willFinishLaunchingWithOptions:` — Этот метод вашего приложения позволяет вам выполнять код во время запуска приложения.
 - `application:didFinishLaunchingWithOptions:` — Этот метод позволяет вам перед окончанием запуска выполнить код прежде чем показать ваше приложение пользователю.
 - `applicationDidBecomeActive:` — Дает вам знать, что оно становятся приложением переднего плана. Используйте этот метод для последних приготовлений.
 - `applicationWillResignActive:` — Дает вам знать, что приложение уходит из режима переднего плана. Используйте этот метод для помещения вашего приложения в режим покоя.
 - `applicationDidEnterBackground:` — Дает вам знать, что приложение запущено в фоне и может быть выключено в любое время.
 - `applicationWillEnterForeground:` — Дает вам знать, что ваше приложение перемещено из фона обратно на передний план, но то, что оно еще не активно.
 - `applicationWillTerminate:` — Дает вам знать, что приложение было выключено. Этот метод не вызывается, если приложение было в состоянии suspended(приостановлено).


## Поток жизненного цикла приложения от запуска до приостановки:

<img width="877" alt="Flow of app life cycle" src="https://github.com/DenDmitriev/iOS-Interview/assets/65191747/efdcd1d4-4914-4e3b-a2f4-9ab479d30831">


## Запуск приложения
Пользователь нажимает на значок приложения
Входной точкой входа в каждом приложении основанном на C является функция `main`. в iOS приложениях это правильно так же соблюдается. Единственное чем отличается, это то, что в iOS приложении вы не должны писать в функцию main самостоятельно. Xcode создает эту функцию как часть основы для вашего проекта. 
```C
//Main function on Objective-C
#import <UIKit/UIKit.h>
#import "AppDelegate.h"
int main(int argc, char * argv[]) {
  @autoreleasepool {
    return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class]));
  }
}
```

`main() -> @main -> Load main UI file -> Initialisation (willFinishLaunchingWithOptions)-> Restore UI state -> Finish Initialisation (didFinishLaunchingWithOptions) -> Running`

Единственное что можно сказать о функции main это то, что работа передается под управление фреймворка UIKit. Функция UIApplicationMain передает этот процесс созданием объекта ядра вашего приложения, загрузкой пользовательского интерфейса вашего приложения из файлов storyboard, вызовом вашего кода, что дает вам шанс настроить что-то во время запуска, и вложение вашего приложения в цикл.

## Неактивное состояние

Неактивно: приложение работает на переднем плане, но в настоящее время не получает события. (Однако это может быть выполнение другого кода.) Приложение обычно остается в этом состоянии ненадолго, когда оно переходит в другое состояние. Приложение может переходить в неактивное состояние при получении звонков/смс. Это также может произойти при переходе в другое состояние. В этом состоянии мы не можем взаимодействовать с пользовательским интерфейсом. Это представлено UIApplication.State.inactive.

## Активное состояние

Активно: это нормальное состояние приложения, при котором приложение остается на переднем плане и получает события. Мы можем перейти в это состояние только из неактивного состояния. Это представлено [UIApplication.State](https://developer.apple.com/documentation/uikit/uiapplication/state).

## Фоновое состояние

Приложение может быть отправлено в фоновое состояние с помощью

 - Нажатие кнопки блокировки экрана
 - Вход в экран многозадачности
 - Нажмите кнопку «Домой» или проведите пальцем вверх.
 - Система выдает предупреждение (например, предупреждение о низком заряде батареи)

Обычно приложение остается в фоновом режиме около 5 секунд в общих случаях, прежде чем перейти в состояние ожидания, но мы можем попросить ОС продлить время, если это необходимо. 
Используя `beginBackgroundTaskWithExpirationHandler`, мы можем запросить дополнительное время для фоновой задачи. Каждый вызов этого метода должен быть сбалансирован соответствующим вызовом метода endBackgroundTask:. Вы можете узнать оставшееся время с помощью backgroundTimeRemaining. Если вы не вызываете endBackgroundTask: для каждой задачи до истечения времени, система убивает приложение.

![1HE7CDcWsduwOcEFySWaGSA](https://github.com/DenDmitriev/iOS-Interview/assets/65191747/c9eb03e4-879c-46c4-8623-9504a275998a)

Есть процессы, которые могут работать бесконечное время в фоновом режиме.

 - Приложения, которые воспроизводят звуковой контент для пользователя в фоновом режиме, например приложение для музыкального проигрывателя.
 - Приложения, которые постоянно информируют пользователей об их местоположении, например, навигационное приложение.

Также есть приложения, которые переходят в фоновый режим по мере необходимости.

 - Приложения, поддерживающие передачу голоса по интернет-протоколу (VoIP).
 - Приложения газетного киоска, которым необходимо загружать и обрабатывать новый контент.
 - Приложения, которые получают регулярные обновления от внешних аксессуаров

Переход в фоновый режим осуществляется в след алгоритме:

Вошел ли фоновый режим -> Может работать в фоновом режиме?
 - Да -> handle events (execute code) -> Sleep/Suspend
 - Нет -> Suspend -> If there is a memory warning -> Terminate

## Приостановленное состояние

Приложение переходит в это состояние из фонового состояния (в промежутке между ними вызывается неактивное состояние) операционной системой. В этом состоянии приложение остается в памяти, но не выполняет никакого кода. Поскольку в этом состоянии приложение ничего не делает, это не влияет на срок службы батареи. Приложение не будет получать уведомления при переходе в приостановленное состояние.

Если какому-либо приложению требуется память, а системе не хватает памяти, ОС может принять решение о завершении приложения из приостановленного состояния.

## Выключение приложения

Приложение должно быть всегда готово к тому, что его могут отключить в любое время и не должно ждать, пока сохранятся какие-то настройки или данные. Выключение это нормальная часть жизненного цикла приложения. Система обычно выключает приложения, для очищения памяти или подготовки к запуску других приложений, которые запущены пользователем, но система так же может выключить приложения, которые работают некорректно или не отвечают.

Приложения в приостановленном режиме не получают уведомления о завершении. Система убивает процесс и освобождает соотвествующую память. Если приложение запущено в фоне и не отвечает, система вызовет `applicationWillTerminate:` чтобы приложение подготовилось к выключению. Система не вызывает метод когда устройство перезагружается.

В дополнение, система выключает выше приложение, когда пользователь выключил его с помощью интерфейса мультизадачности. Выключение вызванное пользователем вызывает такой же эффект как при выключении приложения в приостановленном режиме. Процессы приложения удаляется так же без предупреждения.

## Главный цикл событий (The Main Run Loop)
- Main Run Loop приложения обрабатывает все события, связанные с пользователем.
- Делегат приложения настраивает Main Run Loop во время запуска и использует его для обработки событий и обработки обновлений интерфейса.
- Main Run Loop выполняется в основном потоке приложения
- Главный поток (main thread) является последовательным потоком, и это гарантирует, что события, связанные с пользователем, обрабатываются последовательно в том порядке, в котором они были получены.

# Вопросы на интервью
## Как фоновое приложение iOS возобновляется на переднем плане
Когда пользователь запускает приложение, которое в настоящее время находится в фоновом режиме, система перемещает приложение в неактивное состояние, а затем в активное состояние.
`Background -> Inactive -> Active`

<img width="616" alt="App gets resumed in foreground" src="https://github.com/DenDmitriev/iOS-Interview/assets/65191747/9f85dd44-49ef-4c7b-8b62-8c0964ca64b3">

## Каковы шаги, которые происходят при запуске приложения впервые или после перезагрузки устройства?
Когда пользователь запускает приложение в первый раз или после перезагрузки устройства или после того, как система завершает работу приложения, система перемещает приложение в активное состояние.

<img width="616" alt="App first start or after device rebooted" src="https://github.com/DenDmitriev/iOS-Interview/assets/65191747/2132abbe-55f5-4c86-b83e-b47bd223b77a">

## Каковы шаги, которые происходят когда приложение перемещается с переднего плана на фон?

<img width="616" alt="App moves from foreground to background" src="https://github.com/DenDmitriev/iOS-Interview/assets/65191747/74ab7b12-96fa-47cd-a22e-24bf097614ce">

## Как отказаться от фонового исполнения?
Вы можете явно отказаться от фонового выполнения, добавив ключ UIApplicationExitsOnSuspend в файл Info.plist приложения и установив его значение YES.
Когда вы отказываетесь от фонового состояния, жизненные циклы приложения будут находиться между неработающими (not running), неактивными  (inactive) и активным (active) состояниями и никогда не попадают в фоновые (background) или приостановленные (suspended) состояния.

## Каково состояние приложения при перезагрузке устройства?
Не запущено (Not Running state)

## Когда приложение работает, но не получает событие. В каком состоянии находится приложение?
Не активно (Inactive state)

## Как приложение iOS реагирует на прерывания, такие как SMS, всоядя звонок, календарь и т. д.?
Приложение временно переходит в неактивное состояние, и оно остается в этом состоянии до тех пор, пока пользователь не решит, принимать или игнорировать прерывание.
- Если пользователь игнорирует прерывание, приложение повторно активируется.
- Если пользователь принимает прерывание, приложение переходит в приостановленное (suspended) состояние.

<img width="616" alt="App interrupts" src="https://github.com/DenDmitriev/iOS-Interview/assets/65191747/d5b2b09d-d1c7-49a5-81a0-0f5920eccc1c">

##  Каковы возможности использования в фоновом состоянии?
- Это дает возможность выполнить код для сохранить любых данных приложения, которые помогут потом приложению запустится или какой-либо другой функционал.
- Приложение освобождает ресурсы, которые перестали быть нужны.

## Как вы можете добавить дополнительное время выполнения в фоновом режиме для вашего приложения?
Приложение может оставаться в фоновом режиме в течение нескольких секунд, и вы можете выполнить любой код в течение этого времени.
- Вы можете вызвать метод `beginBackgroundTask(expirationHandler handler: (() -> Void)? = nil)`, который запрашивает дополнительное время фонового выполнения для вашего приложения.
- Чтобы продлить время выполнения расширения приложения, используйте метод `performExpiringActivity(withReason:using:)`

`backgroundTimeRemaining` вернет максимальное количество времени, оставшееся для работы приложения в фоновом режиме. Значение действительно только после того, как приложение перейдет в фоновый режим и запустит хотя бы одну задачу, используя `beginBackgroundTask(expirationHandler:)`. Для отладки фоновой задачи нужно использовать метом `beginBackgroundTask(withName:expirationHandler:)`.

## Источники
- [Application life cycle in iOS](https://manasaprema04.medium.com/application-life-cycle-in-ios-f7365d8c1636)
